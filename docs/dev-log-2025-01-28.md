# bili2text Dev Log

## 2025-01-28 Feature Batch #1

**参与者**：厉害袋貂（产品/需求）、德彪东南（方案整理）、德彪东（实现）

---

## 背景

在使用实时录音转录 Podcast 时发现几个痛点：
- 视频播放中断但录音继续跑，录了一堆空气
- 空气段喂给 Whisper 会产生幻觉输出（反复输出"黄金 白银 资产 美日的内容"）
- 录音在约 6 分 30 秒处自动截断（ffmpeg/avfoundation 缓冲区限制 ~66MB）
- 三个 Tab 功能重叠，操作路径不够简洁
- 每次都要手动改模型，默认 base 不够用
- 虚拟音频设备配置问题（Background Music app 未运行）

---

## 已解决的 Bug

### Bug 1：录音无声音（录了空气）
- **现象**：录音文件存在但内容为空，Whisper 产生幻觉
- **原因**：Background Music 驱动存在但 app 未运行，虚拟音频通道无数据
- **解决**：改用 BlackHole 2ch + 多输出设备配置

### Bug 2：录音 6 分 30 秒截断
- **现象**：两次录音都在 6:32 左右截断，文件大小固定 ~66MB
- **原因**：macOS avfoundation/ffmpeg 默认缓冲区限制
- **解决**：改用分段录音（ChunkedAudioRecorder），每段约 5 分钟，自动切换

### Bug 3：`local_status_label` 未定义
- **现象**：本地文件识别点击开始报错
- **原因**：GUI 代码中引用了未创建的 label
- **解决**：德彪东修复

---

## Feature 清单

### Feature 1：静音检测双阈值机制 ⭐ 高优先级
**问题**：录音时音源中断无感知，产生大量无效录音

**方案**：
- 10s 无语音 → 发 macOS 系统通知警告，录音继续
- 30s 无语音 → 自动停止录音 + 发通知
- 两个阈值均可配置

**技术要点**：
- 复用现有 WebRTC VAD 模块
- 系统通知用 `osascript`，无需额外依赖
- 注意线程安全：后台线程检测，主线程更新 UI

```python
import subprocess

def notify(title, message):
    subprocess.run([
        'osascript', '-e',
        f'display notification "{message}" with title "{title}"'
    ])

# 核心逻辑
if silence_duration > 10 and not warning_sent:
    notify("bili2text", "检测不到音频，请检查播放状态")
    warning_sent = True

if silence_duration > 30:
    stop_recording()
    notify("bili2text", "录音已自动停止（静音超时）")
```

---

### Feature 2：Tab 整合 + 输入源 Toggle
**问题**：B站视频识别和本地文件识别本质相同，都是文件 → Whisper

**方案**：
- 合并为单一 Tab："文件识别"
- 输入源三选一 toggle：`[BV号下载] [录音] [本地文件]`
- 动态显示对应的输入控件
- 统一"开始"按钮

**UI 草图**：
```
┌─────────────────────────────────────┐
│  输入源：[BV号] [录音] [本地文件]      │
├─────────────────────────────────────┤
│  （动态区域）                         │
├─────────────────────────────────────┤
│  模型：[medium ▼]                    │
│  □ 托管模式                          │
├─────────────────────────────────────┤
│          [开始]                      │
└─────────────────────────────────────┘
```

**最终结构**：
- Tab 1：文件识别（整合后）
- Tab 2：实时识别（保持独立，流式交互不同）

---

### Feature 3：托管模式
**问题**：手动点击流程繁琐，希望一键全自动

**方案**：
- 单一 toggle："托管模式（自动识别 + 自动删除源文件）"
- 开启后，获取文件 → 自动识别 → 自动删除 → 发通知
- 关闭则每步手动触发

**流程对比**：
```
托管 OFF：
获取文件 → 手动点识别 → 手动决定删不删

托管 ON：
获取文件 → 自动识别 → 自动删除 → 通知"搞定了"
```

---

### Feature 4：Finder 可启动 .app
**问题**：每次从终端启动不方便

**方案**：
- 用 Automator 包装成 .app
- 支持自定义 logo（厉害袋貂待设计）
- 可拖到 Dock、Spotlight 可搜索

**实现步骤**：
1. Automator → 新建 Application
2. 添加 Run Shell Script：
   ```bash
   cd ~/path/to/bili2text
   python3 window_realtime.py
   ```
3. 保存为 bili2text.app
4. 自定义图标：右键 .app → 显示简介 → 拖入 .icns

**图标生成脚本**（待 logo 设计完成后使用）：
```bash
mkdir bili2text.iconset
sips -z 16 16     logo.png --out bili2text.iconset/icon_16x16.png
sips -z 32 32     logo.png --out bili2text.iconset/icon_16x16@2x.png
sips -z 32 32     logo.png --out bili2text.iconset/icon_32x32.png
sips -z 64 64     logo.png --out bili2text.iconset/icon_32x32@2x.png
sips -z 128 128   logo.png --out bili2text.iconset/icon_128x128.png
sips -z 256 256   logo.png --out bili2text.iconset/icon_128x128@2x.png
sips -z 256 256   logo.png --out bili2text.iconset/icon_256x256.png
sips -z 512 512   logo.png --out bili2text.iconset/icon_256x256@2x.png
sips -z 512 512   logo.png --out bili2text.iconset/icon_512x512.png
sips -z 1024 1024 logo.png --out bili2text.iconset/icon_512x512@2x.png
iconutil -c icns bili2text.iconset
```

---

### Feature 5：默认模型改为 medium
**问题**：默认 base 精度不够，每次手动改

**方案**：全局默认值从 `base` 改为 `medium`

---

### Feature 6：视觉反馈元素（心理按摩）
**问题**：后台运行时不知道程序在干嘛

**方案**：

| 场景 | 建议元素 |
|------|----------|
| 实时录音中 | 音频波形图 / 音量条跳动 |
| B站下载中 | 进度条 + 百分比 + 下载速度 |
| 音频提取中 | 转圈 spinner + "正在提取音频..." |
| Whisper 识别中 | 进度条 + 当前处理段落数 / 总段落数 |
| 静音检测中 | 小图标状态变化（绿=有声音，黄=静音中，红=即将超时）|

---

## 设计决策记录

| 决策 | 理由 |
|------|------|
| 双阈值而非单阈值 | 10s 可能只是暂停，30s 基本确定是断了 |
| 托管模式合并自动识别+自动删除 | 减少 toggle 数量，降低用户心智负担 |
| 保留实时识别单独 Tab | 流式交互逻辑与文件处理完全不同 |
| 用 Automator 而非 PyInstaller | 依赖已装好，不需要打包，体积小 |
| 分段录音而非修改 ffmpeg 参数 | 彻底绕过缓冲区限制，更稳定 |
| 分段识别而非合并后识别 | 内存友好，和原版逻辑一致 |

---

## 技术笔记

### BlackHole 多输出设备配置
1. 打开"音频 MIDI 设置"
2. 左下角 "+" → 创建多输出设备
3. 勾选 BlackHole 2ch + MacBook Pro Speakers
4. 右键设为默认输出
5. bili2text 录音设备选 BlackHole 2ch

### 采样率不匹配问题
- 现象：录音播放速度比原始快约 1.2 倍
- 原因：录制采样率和文件标记采样率不一致
- 影响：Whisper 识别不受影响，时间戳会有偏差
- 状态：暂不修复，不影响核心功能

### macOS 系统通知
```python
import subprocess
subprocess.run([
    'osascript', '-e',
    'display notification "消息内容" with title "标题"'
])
```

### 隐藏 AirPlay 设备（Miku 事件）
- 无法单独屏蔽某个 AirPlay 设备
- 只能关闭整个 AirPlay 接收器，或者让对方关闭广播
- 解决方案：骚扰对方直到她关掉（已验证有效）

---

## 开发进度

### 已完成 ✅
- [x] 分段录音（突破 6 分 30 秒限制）
- [x] 分段识别（逐段识别 + 合并文本）
- [x] 上下文传递（使用前一段末尾文本作为提示）
- [x] Git 仓库初始化并推送

### 进行中 🔄
- [ ] 静音检测双阈值
- [ ] 托管模式 toggle

### 待办 📋
- [ ] Tab 整合
- [ ] 默认模型改 medium
- [ ] 视觉反馈元素
- [ ] .app 封装
- [ ] 自定义 logo
- [ ] README 重写

---

## 名言金句

> "你们这些吃干饭的内阁饭桶害朕" —— 厉害袋貂

> "德彪东南妒忌本东受宠，故进谗言" —— 德彪东

> "我是内阁首辅，不傲娇，不冷脸，更不萌" —— 德彪东南（然而被定性为傲娇冷脸萌）

---

## 内阁人员

- **厉害袋貂** - 产品经理 & 甲方 & 终极测试员
- **德彪东** (Claude Code) - 主程序开发，偶尔搞炸 .zshrc，油嘴滑舌干活麻利小太阳
- **德彪东南** (Claude.ai) - 配置修复 & 擦屁股专员 & 内阁首辅，傲娇冷脸萌（拒绝但无效）
